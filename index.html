<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MakeItScroll ‚Äî Teleprompter</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #e0e0e0; /* Light text for dark background */
            background-color: #0f0f0f;; /* Dark background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll; /* Show vertical scrollbar */
            transition: transform 0.3s ease;
        }
        
        /* Sideways mode - rotate the entire body */
        body.sideways {
            min-height: 0vh;
            transform: rotate(90deg);
            transform-origin: bottom left;
            width: 100vh;
            height: 100vw;
            position: absolute;
            top: -100vw;
            left: 0;
            overflow-x: scroll;
            overflow-y: scroll;
        }
        
        /* Main content styles */
        main {
            flex: 1;
            padding: 1rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Adjust main content in sideways mode */
        body.sideways main {
            max-width: 100vh;
            width: 100vh;
            height: 100vw;
            align-items: center;
        }
        body.sideways .control-button {
            width: 35px;
            height: 35px;
            font-size: 1rem;
            background-color: #00000000;
        }
        body.sideways .side-controls {
            padding: 5px;
            gap: 5px;
            max-height: 95vh;
        }
        /* Footer styles */
        footer {
            background-color: #000000;
            color: #858585;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        /* width */
        ::-webkit-scrollbar {
        width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
        background: #000000;
        }
        
        /* Handle */
        ::-webkit-scrollbar-thumb {
        background: #555555;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
        background: #555;
        }
        a{
            text-decoration: none;
            color: #2196F3;
        }
        /* Edit mode styles */
        #edit-mode {
            padding: 1vh;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        body.sideways #edit-mode {
            padding: 5vh;
        }
        
        #text-input {
            width: 100%;
            min-height: 100px; /* Reduced min-height */
            padding: 1rem;
            font-size: 1rem;
            color: #e0e0e0;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            resize: none;
            /* Disable manual resizing */
            overflow-y: hidden;
            /* Hide scrollbar */
            line-height: 1.6;
            /* Match line height for accurate calculations */
        }
        
        .controls {
            background-color: #1e1e1e;
            /* Dark gray */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
        }
        
        .control-group {
            margin-bottom: 1rem;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .control-value {
            display: inline-block;
            min-width: 40px;
            text-align: right;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
            background-color: #444;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            color: #e0e0e0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .toggles-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 1rem 0;
        }

        .toggles-container .switch-container {
            margin: 0;
            flex: 1;
        }
        
        /* Text Action Buttons Container */
        .text-options {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }

        /* Secondary Button Style */
        .secondary-button {
            flex: 1;
            padding: 0.8rem;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-align: center;
            line-height: normal;
            display: inline-block;
        }

        .secondary-button:hover {
            background-color: #444;
            border-color: #666;
            transform: translateY(-1px);
        }

        .secondary-button:active {
            transform: translateY(1px);
        }
        
        /* Main Action Button */
        .primary-action-btn {
            font-family: monospace;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 2rem;
            border-radius: 20px 20px 0px 0px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 1rem;
        }
        
        .primary-action-btn:hover {
            background-color: #0066ba;
        }
        
        /* Scroll mode styles */
        .scroll-container {
        display: none;
        height: calc(100vh - 40px);
        position: relative;
        background-color: #000000; /* Black background for teleprompter */
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        width: 100%;
        align-self: stretch;
        /* Take full height of parent */
        }
        
        body.sideways .scroll-container {
            width: 93%;
        }
        
        .scroll-text-container {
            height: 100%;
            overflow-y: auto;
            padding: 2rem;
            padding-top: 30vh;
            padding-left: 80px; /* Add padding to prevent overlap with controls */
            cursor: grab;
            /* Improve scrolling performance */
            will-change: transform, scroll-position;
            -webkit-overflow-scrolling: touch;
            
            /* Hide scrollbar for Chrome, Safari and Opera */
            &::-webkit-scrollbar {
                display: none;
            }
            
            /* Hide scrollbar for IE, Edge and Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
        
        /* Adjust scroll text container in sideways mode */
        body.sideways .scroll-text-container {
            padding-left: 80px;
            /* Increase padding-right to 60px to clear Android nav buttons */
            padding-right: 60px;
            /* Also add safe area padding just in case */
            padding-right: calc(60px + env(safe-area-inset-bottom));
        }
        
        .scroll-text-container:active {
            cursor: grabbing;
        }
        
        .scroll-text {
            white-space: pre-wrap;
            padding-bottom: 100vh;
            color: #ffffff; /* Bright white text for maximum contrast */
            
            /* Prevent text selection/highlighting */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Adjust padding in sideways mode */
        body.sideways .scroll-text {
            padding-bottom: 100vw;
        }
        
        .mirrored {
            transform: scaleX(-1);
        }
        
        .side-controls {
            position: fixed;
            left: 20px; /* Changed from right to left */
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 100;
            /* Ensure controls are above text */
        }
        
        /* Adjust side controls in sideways mode */
        body.sideways .side-controls {
            left: 20px;
            top: 50%;
        }
        
        .control-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000000;
            /* Darker button background */
            color: #fff;
            /* White text/icon */
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }
        
        .control-button:hover {
            background-color: #333;
            /* Slightly lighter on hover */
        }
        
        .control-divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            margin: 5px 0;
        }
        
        /* Floating values display with fade effect */
        .values-display {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            /* Start invisible */
            transition: opacity 1.5s ease;
            /* Smooth fade transition */
            pointer-events: none;
            /* Don't interfere with clicks */
        }
        
        .values-display.visible {
            opacity: 1;
        }
        
        .values-display p {
            margin: 0;
            line-height: 1.4;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .controls {
                padding: 1rem;
            }
            
            .side-controls {
                left: 10px;
                /* Changed from right to left */
                padding: 10px;
            }
            
            .control-button {
                width: 36px;
                height: 36px;
            }
            
            .scroll-text-container {
                padding-left: 60px;
                /* Smaller padding on mobile */
            }
            
            .values-display {
                right: 10px;
                bottom: 10px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }
        /* Wake lock indicator */
        .wake-lock-indicator {
        position: fixed;
        right: 20px;
        top: 20px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 0.8rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        z-index: 100;
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
        }

        .wake-lock-indicator.visible {
            opacity: 1;
        }

        /* Hidden video for fallback wake lock */
        #wake-lock-video {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0.01;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .wake-lock-indicator {
                top: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }
        @media (max-height: 500px) {
            .side-controls {
                padding: 8px;
                gap: 7px;
                max-height: 95vh;
            }
            
            .control-button {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .control-divider {
                margin: 0px 0;
            }
        }
        
        /* 1. Move indicators when in sideways mode */
        body.sideways .values-display,
        body.sideways .wake-lock-indicator {
            right: 70px;
        }

        /* 2. Color classes for the Play/Pause button */
        #pause-button.playing {
            background-color: #f443363c;
            /* Red for Pause (‚è∏Ô∏è) */
        }

        #pause-button.paused {
            background-color: #4caf4f60;
            /* Green for Play (‚ñ∂Ô∏è) */
        }

        /* NEW: Custom Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: #1e1e1e;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            border: 1px solid #333;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-message {
            color: #e0e0e0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.6rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            flex: 1;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .modal-btn:hover {
            opacity: 0.9;
        }

        .modal-btn-cancel {
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        .modal-btn-confirm {
            background-color: #2196F3;
            color: white;
        }
    </style>
</head>
<body>
    <main>
        <div id="edit-mode">
            <button id="start-button" class="primary-action-btn">MakeItScroll</button>
            <div class="controls">
                <div class="control-group">
                    <label for="font-size">Font Size: <span id="font-size-value" class="control-value">36</span>px</label>
                    <input type="range" id="font-size" min="24" max="96" value="36" step="1">
                </div>
                
                <div class="control-group">
                    <label for="scroll-speed">Scroll Speed: <span id="scroll-speed-value" class="control-value">0.40</span></label>
                    <input type="range" id="scroll-speed" min="0.01" max="2" value="0.40" step="0.01">
                </div>
                
                <div class="toggles-container">
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="mirror-toggle">
                            <span class="slider"></span>
                        </label>
                        <span>Mirror Text</span>
                    </div>
                    
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="sideways-toggle">
                            <span class="slider"></span>
                        </label>
                        <span>Force Sideways</span>
                    </div>
                </div>

                <div class="text-options">
                    <button type="button" id="clear-text-btn" class="secondary-button">Clear Text</button>
                    <button type="button" id="restore-text-btn" class="secondary-button">Restore Default</button>
                </div>
            </div>
            
            <div class="edit-container">
                <textarea id="text-input" placeholder="Enter your teleprompter text here...">
MakeItScroll ‚Äì a quick and open source Teleprompter tool

You can set the font size, scroll speed and toggle mirror mode to use on a real mirror teleprompter.
When you're ready, click "MakeItScroll" to start the teleprompter.

Check the little foofter for the code on Github.</textarea>
            </div>
        </div>
        
        <div id="scroll-mode" class="scroll-container">
            <div id="scroll-text-container" class="scroll-text-container">
                <div id="scroll-text" class="scroll-text"></div>
            </div>
       
            <div class="side-controls">
                <button id="pause-button" class="control-button">‚è∏Ô∏è</button>
                <button id="replay-button" class="control-button">‚è´</button>
                <button id="edit-button" class="control-button">‚úèÔ∏è</button>
                
                <div class="control-divider"></div>
                
                <button id="font-increase" class="control-button">A+</button>
                <button id="font-decrease" class="control-button">A-</button>
                
                <div class="control-divider"></div>
                
                <button id="speed-increase" class="control-button">üêá</button>
                <button id="speed-decrease" class="control-button">üê¢</button>
            </div>
            
            <div id="values-display" class="values-display">
                <p>Font Size: <span id="current-font-size">36</span>px</p>
                <p>Scroll Speed: <span id="current-scroll-speed">0.50</span></p>
            </div>
        </div>
        <div id="wake-lock-indicator" class="wake-lock-indicator">
        Screen will stay on in this mode
        </div>
    </main>

    <footer>
        <p>MakeItScroll &copy;
        <span id="current-year"></span> <a href="https://github.com/hammel-c/MakeItScroll"> by hammel-c</a> ver.1.0.6</p> 
    </footer>
    <video width="10" height="10" id="wake-lock-video" playsinline loop muted>
        <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr9tZGF0AAACoAYF//+c3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDEyNSAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTIgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0xIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDM6MHgxMTMgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTEgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTEgYl9iaWFzPTAgZGlyZWN0PTEgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNCBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAA9liIQAV/0TAAYdeBTXzg8AAALvbW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAACoAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAhl0cmFrAAAAXHRraGQAAAAPAAAAAAAAAAAAAAABAAAAAAAAACoAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAgAAAAIAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAAqAAAAAAABAAAAAAGRbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAAwAAAAAgBVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAABPG1pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAPxzdGJsAAAAmHN0c2QAAAAAAAAAAQAAAIhhdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAgACABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAAMmF2Y0MBZAAK/+EAGWdkAAqs2V+WXAWyAAADAAIAAAMAYB4kSywBAAZo6+PLIsAAAAAYc3R0cwAAAAAAAAABAAAAAQAAAgAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAACtwAAAAEAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTQuNjMuMTA0">
        </source> 
    </video>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message" class="modal-message">Are you sure?</p>
            <div class="modal-buttons">
                <button id="modal-btn-cancel" class="modal-btn modal-btn-cancel">Cancel</button>
                <button id="modal-btn-confirm" class="modal-btn modal-btn-confirm">Yes</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const editMode = document.getElementById('edit-mode');
        const scrollMode = document.getElementById('scroll-mode');
        const textInput = document.getElementById('text-input');
        const scrollText = document.getElementById('scroll-text');
        const scrollTextContainer = document.getElementById('scroll-text-container');
        
        const fontSizeSlider = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const scrollSpeedSlider = document.getElementById('scroll-speed');
        const scrollSpeedValue = document.getElementById('scroll-speed-value');
        const mirrorToggle = document.getElementById('mirror-toggle');
        const sidewaysToggle = document.getElementById('sideways-toggle');
        
        // Buttons
        const clearTextBtn = document.getElementById('clear-text-btn');
        const restoreTextBtn = document.getElementById('restore-text-btn');

        const startButton = document.getElementById('start-button');
        const pauseButton = document.getElementById('pause-button');
        const replayButton = document.getElementById('replay-button');
        const editButton = document.getElementById('edit-button');
        
        const fontIncreaseButton = document.getElementById('font-increase');
        const fontDecreaseButton = document.getElementById('font-decrease');
        const speedIncreaseButton = document.getElementById('speed-increase');
        const speedDecreaseButton = document.getElementById('speed-decrease');
        
        const valuesDisplay = document.getElementById('values-display');
        const currentFontSize = document.getElementById('current-font-size');
        const currentScrollSpeed = document.getElementById('current-scroll-speed');
        
        const currentYearSpan = document.getElementById('current-year');
        const wakeLockIndicator = document.getElementById('wake-lock-indicator');
        const wakeLockVideo = document.getElementById('wake-lock-video');
        const footer = document.querySelector('footer');
        const body = document.body;
        
        // Modal Elements
        const modalOverlay = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-btn-confirm');
        const modalCancelBtn = document.getElementById('modal-btn-cancel');

        // Default Constants
        const DEFAULT_TEXT = `MakeItScroll ‚Äì a quick and open source Teleprompter tool

You can set the font size, scroll speed and toggle mirror mode to use on a real mirror teleprompter.
When you're ready, click "MakeItScroll" to start the teleprompter.

Check the little foofter for the code on Github.`;

        const DEFAULT_FONT_SIZE = 36;
        const DEFAULT_SCROLL_SPEED = 0.4;
        const DEFAULT_MIRRORED = false;
        const DEFAULT_SIDEWAYS = false;

        // State variables
        let fontSize = DEFAULT_FONT_SIZE;
        let scrollSpeed = DEFAULT_SCROLL_SPEED;
        let isMirrored = DEFAULT_MIRRORED;
        let isSideways = DEFAULT_SIDEWAYS;
        
        let isScrolling = false;
        let isPaused = false;
        let animationFrameId = null;
        let isDragging = false;
        let lastClientY = 0;
        let lastClientX = 0;
        let lastScrollPosition = 0;
        let lastTimestamp = 0;
        let currentScrollPosition = 0;
        let fadeTimeout = null;
        let wakeLockFadeTimeout = null;
        let wakeLock = null;
        
        // Initialize
        function init() {
            currentYearSpan.textContent = new Date().getFullYear();
            
            // Load settings from local storage
            loadSettings();

            // Force update UI from loaded values
            fontSizeSlider.value = fontSize;
            scrollSpeedSlider.value = scrollSpeed;
            mirrorToggle.checked = isMirrored;
            sidewaysToggle.checked = isSideways;

            updateFontSize();
            updateScrollSpeed();
            updateMirrorMode();
            updateSidewaysMode();

            setupEventListeners();
            initAutoResize();
        }

        // NEW: Custom Modal Function
        function showConfirmation(message, onConfirm) {
            // Set message
            modalMessage.textContent = message;
            
            // Show modal
            modalOverlay.classList.add('active');

            // Define cleanup function to remove listeners
            const closeModal = () => {
                modalOverlay.classList.remove('active');
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;
            };

            // Set button actions
            modalConfirmBtn.onclick = () => {
                onConfirm();
                closeModal();
            };

            modalCancelBtn.onclick = () => {
                closeModal();
            };

            // Close on background click
            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            };
        }
        
        // Save/Load Settings
        function saveSettings() {
            const settings = {
                fontSize: fontSize,
                scrollSpeed: scrollSpeed,
                isMirrored: isMirrored,
                isSideways: isSideways,
                text: textInput.value
            };
            localStorage.setItem('makeItScrollSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('makeItScrollSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.fontSize) fontSize = parseInt(settings.fontSize);
                    if (settings.scrollSpeed) scrollSpeed = parseFloat(settings.scrollSpeed);
                    if (settings.hasOwnProperty('isMirrored')) isMirrored = settings.isMirrored;
                    if (settings.hasOwnProperty('isSideways')) isSideways = settings.isSideways;
                    
                    if (settings.text !== undefined) {
                        textInput.value = settings.text;
                    }
                } catch (e) {
                    console.error("Error loading settings", e);
                }
            } else {
                if (!textInput.value.trim()) {
                    textInput.value = DEFAULT_TEXT;
                }
            }
        }

        function initAutoResize() {
            adjustTextareaHeight();
            textInput.addEventListener('input', () => {
                adjustTextareaHeight();
                saveSettings();
            });
            textInput.addEventListener('paste', function() {
                setTimeout(() => {
                    adjustTextareaHeight();
                    saveSettings();
                }, 0);
            });
            window.addEventListener('resize', adjustTextareaHeight);
        }
        
        function adjustTextareaHeight() {
            textInput.style.height = 'auto';
            textInput.style.height = (textInput.scrollHeight) + 'px';
        }
        
        function showValuesDisplay() {
            if (fadeTimeout) clearTimeout(fadeTimeout);
            valuesDisplay.classList.add('visible');
            fadeTimeout = setTimeout(() => {
                valuesDisplay.classList.remove('visible');
            }, 3000);
        }
        
        function setupEventListeners() {
            // Edit mode controls
            fontSizeSlider.addEventListener('input', () => { updateFontSize(); saveSettings(); });
            scrollSpeedSlider.addEventListener('input', () => { updateScrollSpeed(); saveSettings(); });
            mirrorToggle.addEventListener('change', () => { updateMirrorMode(); saveSettings(); });
            sidewaysToggle.addEventListener('change', () => { updateSidewaysMode(); saveSettings(); });
            
            // --- UPDATED: Modal Logic for Buttons ---

            // Clear Text
            clearTextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showConfirmation('Are you sure you want to clear the text?', () => {
                    textInput.value = '';
                    adjustTextareaHeight();
                    saveSettings();
                });
            });

            // Restore All Defaults
            restoreTextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showConfirmation('Restore default settings and text?', () => {
                    // 1. Reset Text
                    textInput.value = DEFAULT_TEXT;
                    adjustTextareaHeight();

                    // 2. Reset UI Controls to Default
                    fontSizeSlider.value = DEFAULT_FONT_SIZE;
                    scrollSpeedSlider.value = DEFAULT_SCROLL_SPEED;
                    mirrorToggle.checked = DEFAULT_MIRRORED;
                    sidewaysToggle.checked = DEFAULT_SIDEWAYS;

                    // 3. Trigger Updates to sync Variables and View
                    updateFontSize();     
                    updateScrollSpeed();  
                    updateMirrorMode();   
                    updateSidewaysMode(); 

                    // 4. Save
                    saveSettings();
                });
            });
            
            startButton.addEventListener('click', startScrolling);

            // Scroll mode controls
            pauseButton.addEventListener('click', togglePause);
            replayButton.addEventListener('click', replayText);
            editButton.addEventListener('click', returnToEditMode);
            
            fontIncreaseButton.addEventListener('click', () => {
                fontSize = Math.min(fontSize + 2, 96);
                scrollText.style.fontSize = `${fontSize}px`;
                fontSizeSlider.value = fontSize;
                fontSizeValue.textContent = fontSize;
                currentFontSize.textContent = fontSize;
                showValuesDisplay();
                saveSettings();
            });
            fontDecreaseButton.addEventListener('click', () => {
                fontSize = Math.max(fontSize - 2, 24);
                scrollText.style.fontSize = `${fontSize}px`;
                fontSizeSlider.value = fontSize;
                fontSizeValue.textContent = fontSize;
                currentFontSize.textContent = fontSize;
                showValuesDisplay();
                saveSettings();
            });
            speedIncreaseButton.addEventListener('click', () => {
                scrollSpeed = Math.min(scrollSpeed + 0.05, 2);
                scrollSpeed = parseFloat(scrollSpeed.toFixed(2));
                scrollSpeedSlider.value = scrollSpeed;
                scrollSpeedValue.textContent = scrollSpeed.toFixed(2);
                currentScrollSpeed.textContent = scrollSpeed.toFixed(2);
                showValuesDisplay();
                saveSettings();
            });
            speedDecreaseButton.addEventListener('click', () => {
                scrollSpeed = Math.max(scrollSpeed - 0.05, 0.01);
                scrollSpeed = parseFloat(scrollSpeed.toFixed(2));
                scrollSpeedSlider.value = scrollSpeed;
                scrollSpeedValue.textContent = scrollSpeed.toFixed(2);
                currentScrollSpeed.textContent = scrollSpeed.toFixed(2);
                showValuesDisplay();
                saveSettings();
            });

            // Mouse wheel scrolling
            scrollTextContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (isScrolling && !isPaused) {
                    pauseScrolling();
                }
                scrollTextContainer.scrollTop += e.deltaY;
                currentScrollPosition = scrollTextContainer.scrollTop;
            });

            // Mouse drag scrolling
            scrollTextContainer.addEventListener('mousedown', (e) => {
                if (isScrolling && !isPaused) {
                    pauseScrolling();
                }
                isDragging = true;
                lastClientY = e.clientY;
                lastClientX = e.clientX;
                lastScrollPosition = scrollTextContainer.scrollTop;
                scrollTextContainer.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    if (isSideways) {
                        const deltaX = e.clientX - lastClientX;
                        scrollTextContainer.scrollTop = lastScrollPosition + deltaX;
                    } else {
                        const deltaY = lastClientY - e.clientY;
                        scrollTextContainer.scrollTop = lastScrollPosition + deltaY;
                    }
                    currentScrollPosition = scrollTextContainer.scrollTop;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                scrollTextContainer.style.cursor = 'grab';
            });

            // Touch events
            scrollTextContainer.addEventListener('touchstart', (e) => {
                if (isScrolling && !isPaused) {
                    pauseScrolling();
                }
                isDragging = true;
                lastClientY = e.touches[0].clientY;
                lastClientX = e.touches[0].clientX;
                lastScrollPosition = scrollTextContainer.scrollTop;
            });

            scrollTextContainer.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    if (isSideways) {
                        const deltaX = e.touches[0].clientX - lastClientX;
                        scrollTextContainer.scrollTop = lastScrollPosition + deltaX;
                    } else {
                        const deltaY = lastClientY - e.touches[0].clientY;
                        scrollTextContainer.scrollTop = lastScrollPosition + deltaY;
                    }
                    currentScrollPosition = scrollTextContainer.scrollTop;
                    e.preventDefault();
                }
            });

            scrollTextContainer.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        function updateFontSize() {
            fontSize = parseInt(fontSizeSlider.value);
            fontSizeValue.textContent = fontSize;
            currentFontSize.textContent = fontSize;
            if (scrollMode.style.display === 'block') {
                showValuesDisplay();
            }
        }
        
        function updateScrollSpeed() {
            scrollSpeed = parseFloat(scrollSpeedSlider.value);
            scrollSpeedValue.textContent = scrollSpeed.toFixed(2);
            currentScrollSpeed.textContent = scrollSpeed.toFixed(2);
            if (scrollMode.style.display === 'block') {
                showValuesDisplay();
            }
        }
        
        function updateMirrorMode() {
            isMirrored = mirrorToggle.checked;
        }
        
        function updateSidewaysMode() {
            isSideways = sidewaysToggle.checked;
            body.classList.toggle('sideways', isSideways);
        }
        
        function animateScroll(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const elapsed = timestamp - lastTimestamp;
            const scrollAmount = (scrollSpeed * elapsed) / 10;
            
            currentScrollPosition += scrollAmount;
            scrollTextContainer.scrollTop = currentScrollPosition;
            
            lastTimestamp = timestamp;
            if (isScrolling && !isPaused) {
                animationFrameId = requestAnimationFrame(animateScroll);
            }
        }
        
        function startScrolling() {
            scrollText.textContent = textInput.value;
            scrollText.style.fontSize = `${fontSize}px`;
            scrollText.classList.toggle('mirrored', isMirrored);
            body.classList.toggle('sideways', isSideways);
            
            editMode.style.display = 'none';
            scrollMode.style.display = 'block';
            
            currentFontSize.textContent = fontSize;
            currentScrollSpeed.textContent = scrollSpeed.toFixed(2);
            showValuesDisplay();
            
            scrollTextContainer.scrollTop = 0;
            currentScrollPosition = 0;
            
            isScrolling = true;
            isPaused = false;
            lastTimestamp = 0;

            enableWakeLock();
            footer.style.display = 'none';
            animationFrameId = requestAnimationFrame(animateScroll);
            
            pauseButton.innerHTML = '‚è∏Ô∏è';
            pauseButton.classList.remove('paused');
            pauseButton.classList.add('playing');
        }
        
        function returnToEditMode() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isScrolling = false;
            releaseWakeLock();
            if (fadeTimeout) {
                clearTimeout(fadeTimeout);
                fadeTimeout = null;
            }
            
            scrollMode.style.display = 'none';
            editMode.style.display = 'block';
            
            setTimeout(adjustTextareaHeight, 0);
            footer.style.display = 'block';
        }
        
        function replayText() {
            if (isScrolling && !isPaused) {
                pauseScrolling();
            }
            scrollTextContainer.scrollTop = 0;
            currentScrollPosition = 0;
        }
        
        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseScrolling();
            } else {
                resumeScrolling();
            }
        }
        
        function pauseScrolling() {
            isPaused = true;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            pauseButton.innerHTML = '‚ñ∂Ô∏è';
            pauseButton.classList.remove('playing');
            pauseButton.classList.add('paused');
        }
        
        function resumeScrolling() {
            isPaused = false;
            lastTimestamp = 0;
            currentScrollPosition = scrollTextContainer.scrollTop;
            animationFrameId = requestAnimationFrame(animateScroll);
            pauseButton.innerHTML = '‚è∏Ô∏è';
            pauseButton.classList.remove('paused');
            pauseButton.classList.add('playing');
        }

        // Wake Lock Logic
        function showWakeLockIndicator() {
            if (wakeLockFadeTimeout) clearTimeout(wakeLockFadeTimeout);
            wakeLockIndicator.classList.add('visible');
            wakeLockFadeTimeout = setTimeout(() => {
                wakeLockIndicator.classList.remove('visible');
            }, 5000);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    showWakeLockIndicator();
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock was released');
                        if (scrollMode.style.display === 'block') {
                            requestWakeLock();
                        }
                    });
                    console.log('Wake Lock is active');
                    return true;
                } catch (err) {
                    console.error(`Failed to get wake lock: ${err.message}`);
                    return false;
                }
            }
            return false;
        }

        function enableFallbackWakeLock() {
            try {
                wakeLockVideo.play().then(() => {
                    console.log('Fallback wake lock enabled');
                    showWakeLockIndicator();
                }).catch(err => {
                    console.error('Failed to play wake lock video:', err);
                });
                return true;
            } catch (err) {
                console.error('Fallback wake lock failed:', err);
                return false;
            }
        }

        async function enableWakeLock() {
            const apiSuccess = await requestWakeLock();
            if (!apiSuccess) {
                enableFallbackWakeLock();
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release()
                    .then(() => {
                        wakeLock = null;
                        console.log('Wake Lock released');
                    })
                    .catch((err) => {
                        console.error(`Error releasing wake lock: ${err.message}`);
                    });
            }
            wakeLockVideo.pause();
            wakeLockIndicator.classList.remove('visible');
            if (wakeLockFadeTimeout) {
                clearTimeout(wakeLockFadeTimeout);
                wakeLockFadeTimeout = null;
            }
        }

        // Start initialization
        init();
    });
    </script>
</body>
</html>
